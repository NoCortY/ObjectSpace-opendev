<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Runtime Info</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="../lib/layui-v2.5.4/css/layui.css" media="all">
    <link rel="stylesheet" href="../lib/layuiadmin/style/admin.css" media="all">
</head>
<body>

<style>
    /* 这段样式只是用于演示 */
    #LAY-component-grid-mobile .layui-card-body {
        display: flex;
        justify-content: center;
        flex-direction: column;
        text-align: center;
        height: 200px;
    }
</style>
<fieldset class='layui-elem-field layui-field-title'>
    <legend>实例运行时监控</legend>

    <div class="layui-fluid" id="LAY-component-grid-mobile">
        <div class="layui-row layui-col-space10" id="cpuDataContainer">

        </div>
        <div class="layui-row layui-col-space10" id="diskDataContainer">
        </div>
        <div class="layui-row layui-col-space10">

            <div class="layui-col-xs6">
                <!-- 填充内容 -->
                <div class="layui-card">
                    <div class="layui-card-header"></div>
                    <div class="layui-card-body">

                    </div>
                </div>
            </div>
            <div class="layui-col-xs6">
                <div class="layui-card">
                    <div class="layui-card-header"></div>
                    <div class="layui-card-body"></div>
                </div>
            </div>

        </div>
    </div>
</fieldset>
<script src="../lib/layui-v2.5.4/layui.js"></script>
<script src="../lib/jquery-3.4.1/jquery-3.4.1.min.js"></script>
<script src="../js/lay-config.js?v=1.0.4" charset="utf-8"></script>
<script src="../js/ConstantPool.js" charset="utf-8"></script>
<script>
    $(function () {
        layui.use(['layuimini', 'element', 'layer', 'echarts'], function () {
            var $ = layui.jquery,
                element = layui.element,
                layer = layui.layer,
                echarts = layui.echarts;

            //获取需要获取指标的IP（从父页面传值）
            var serverIp = getUrlParam("ip");
            /*******************************************************CPU*****************************************************/
                //服务器cpu数据指标
            var cpuRuntimeData;
            //CPU渲染
            var cpuHtmlStr = "";
            //默认请求30分钟的数据，可调
            $.ajax({
                url: ZUUL_URL + "/ComCenter/CC/server/runtimeCpuRecord/" + serverIp + "/" + 30,
                type: 'GET',
                async: false,
                xhrFields: {
                    withCredentials: true
                },
                success: function (data) {
                    cpuRuntimeData = data.data;
                },
                error: function (e) {
                    layuimini.msg_error('网络错误');
                }
            });
            //渲染卡片
            var cardLength = 12 / cpuRuntimeData.length;
            if (cardLength < 3) {
                //卡片长度最少为3
                cardLength = 3;
            }
            $.each(cpuRuntimeData, function (index, cpu) {
                cpuHtmlStr += "<div class=\"layui-col-xs" + cardLength + "\">\n" +
                    "            <div class=\"layui-card\">\n" +
                    "                <div class=\"layui-card-header\"><a href=\"\" style=\"color: blue\">CPU使用率——核心" + cpu.cpuId + "(%)</a> <span style=\"float: right\">周期:30s</span></div>\n" +
                    "                <div class=\"layui-card-body\">\n" +
                    "                    <div id=\"cpu-records-" + cpu.cpuId + "\" style=\"width: 100%;min-height:200px\">Cpu波形图</div>\n" +
                    "                </div>\n" +
                    "            </div>\n" +
                    "        </div>"
            });
            $("#cpuDataContainer").html(cpuHtmlStr);
            //渲染Echarts

            $.each(cpuRuntimeData, function (index, cpu) {
                console.log(cpu);
                var cpuTime = [];
                var cpuUserUsed = [];
                var cpuSystemUsed = [];
                var cpuCombine = [];
                var echartsRecords = echarts.init(document.getElementById('cpu-records-' + cpu.cpuId), 'light');
                $.each(cpu.cpuRecordDtoList, function (index, cpuCore) {
                    cpuTime.push(cpuCore.recordTime);
                    cpuUserUsed.push(cpuCore.userUsed.toFixed(2));
                    cpuSystemUsed.push(cpuCore.systemUsed.toFixed(2));
                    cpuCombine.push(cpuCore.combine.toFixed(2));
                });
                var option = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross',
                            label: {
                                backgroundColor: '#6a7985'
                            }
                        }
                    },
                    splitLine: {    //网格线
                        lineStyle: {
                            type: 'dashed'    //设置网格线类型 dotted：虚线   solid:实线
                        },
                        show: true //隐藏或显示
                    },
                    toolbox: {
                        feature: {
                            saveAsImage: {}
                        }
                    },
                    grid: {
                        top: '3%',
                        left: '1%',
                        right: '3%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: [
                        {
                            type: 'category',
                            boundaryGap: false,
                            data: cpuTime
                        }
                    ],
                    yAxis: [
                        {
                            type: 'value'
                        }
                    ],
                    series: [
                        {
                            name: '总使用率(%)',
                            type: 'line',
                            stack: '总使用率',
                            areaStyle: {},
                            data: cpuCombine
                        }, {
                            name: '用户使用率(%)',
                            type: 'line',
                            stack: '用户使用率',
                            areaStyle: {},
                            data: cpuUserUsed
                        }, {
                            name: '系统使用率(%)',
                            type: 'line',
                            stack: '系统使用率',
                            areaStyle: {},
                            data: cpuSystemUsed
                        }
                    ]
                };
                echartsRecords.setOption(option);
            });
            /***************************************************************************************************************/
            /*******************************************************硬盘*****************************************************/
                //服务器硬盘数据指标
            var DiskRuntimeData;
            //硬盘渲染
            var diskHtmlStr = "";
            //默认请求30分钟的数据，可调
            $.ajax({
                url: ZUUL_URL + "/ComCenter/CC/server/runtimeDiskRecord/" + serverIp + "/" + 30,
                type: 'GET',
                async: false,
                xhrFields: {
                    withCredentials: true
                },
                success: function (data) {
                    diskRuntimeData = data.data;
                },
                error: function (e) {
                    layuimini.msg_error('网络错误');
                }
            });
            //渲染卡片
            var cardLength = 12 / diskRuntimeData.length;
            if (cardLength < 4) {
                //卡片长度最少为4
                cardLength = 4;
            }
            $.each(diskRuntimeData, function (index, disk) {
                diskHtmlStr += "<div class=\"layui-col-xs" + cardLength + "\">\n" +
                    "            <div class=\"layui-card\">\n" +
                    "                <div class=\"layui-card-header\"><a href=\"\" style=\"color: blue\">硬盘读写状况——" + disk.diskName + "(MB/s)</a> <span style=\"float: right\">周期:30s</span></div>\n" +
                    "                <div class=\"layui-card-body\">\n" +
                    "                    <div id=\"disk-records-" + disk.diskName + "\" style=\"width: 100%;min-height:200px\"></div>\n" +
                    "                </div>\n" +
                    "            </div>\n" +
                    "        </div>"
            });
            $("#diskDataContainer").html(diskHtmlStr);

            //渲染Echarts

            $.each(diskRuntimeData, function (index, disk) {
                console.log(disk);
                var diskTime = [];
                var diskReadRate = [];
                var diskWriteRate = [];
                var echartsRecords = echarts.init(document.getElementById('disk-records-' + disk.diskName), 'light');
                $.each(disk.diskRecordDtoList, function (index, diskPartition) {
                    diskTime.push(diskPartition.recordTime);
                    diskReadRate.push((diskPartition.readRate).toFixed(2));
                    diskWriteRate.push((diskPartition.writeRate).toFixed(2));
                });
                var option =
                    {
                        tooltip: {
                            trigger: 'axis'
                        },
                        calculable: true,
                        xAxis: [
                            {
                                type: 'category',
                                boundaryGap: false,
                                data: diskTime
                            }
                        ],
                        grid: {
                            top: '3%',
                            left: '1%',
                            right: '3%',
                            bottom: '3%',
                            containLabel: true
                        },
                        yAxis: [
                            {
                                type: 'value'
                            }
                        ],
                        series: [
                            {
                                name: 'Read(MB/s)',
                                type: 'line',
                                stack: 'Read(MB/s)',
                                data: diskReadRate
                            }, {
                                name: 'Write(MB/s)',
                                type: 'line',
                                stack: 'Write(MB/s)',
                                data: diskWriteRate
                            }
                        ]
                    };

                echartsRecords.setOption(option);
            });
            /***************************************************************************************************************/
//echarts自适应

            /* window.onresize = function(){
                 echartsRecords.resize();
             };*/


        });
    });
</script>
</body>
</html>